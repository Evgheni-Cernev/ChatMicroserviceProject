<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Service Test Page</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Chat Service API Tester</h1>

    <h2>Create Room</h2>
    <input type="number" id="user1Id" placeholder="User 1 ID" />
    <input type="number" id="user2Id" placeholder="User 2 ID" />
    <button onclick="createRoom()">Create Room</button>

    <h2>All Rooms</h2>
    <button onclick="getAllRooms()">Show All Rooms</button>
    <form id="roomsList"></form>

    <h2>Write Message</h2>
    <input type="number" id="sendMessageRoomId" placeholder="Room ID" />
    <input type="number" id="senderId" placeholder="Sender ID" />
    <input type="text" id="messageContent" placeholder="Message Content" />
    <input type="file" id="fileInput" />
    <!-- Input for selecting file -->
    <button onclick="sendMessage()">Send Message</button>

    <h2>Messages in Room</h2>
    <div id="messages"></div>

    <script>
      const apiUrl = "http://localhost:3008/api";
      const getwayApiUrl = "http://localhost:3003";
      const socket = io("http://localhost:3008");

      function createRoom() {
        const user1Id = document.getElementById("user1Id").value;
        const user2Id = document.getElementById("user2Id").value;

        fetch(`${apiUrl}/rooms`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ user1Id, user2Id }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(JSON.stringify(data));
            getAllRooms();
          })
          .catch((error) => alert("Error: " + error));
      }

      function getAllRooms() {
        fetch(`${apiUrl}/rooms/14`)
          .then((response) => response.json())
          .then((data) => {
            const roomsList = document.getElementById("roomsList");
            roomsList.innerHTML = "";
            data.forEach((room, index) => {
              const label = document.createElement("label");
              const radioButton = document.createElement("input");
              radioButton.type = "radio";
              radioButton.name = "room";
              radioButton.value = room.id;
              radioButton.onclick = () => {
                document.getElementById("sendMessageRoomId").value = room.id;
                subscribeToRoom(room.id);
              };
              label.appendChild(radioButton);
              label.appendChild(document.createTextNode(` Room ${room.id}`));
              roomsList.appendChild(label);

              if (index === 0) {
                radioButton.checked = true;
                document.getElementById("sendMessageRoomId").value = room.id;
                subscribeToRoom(room.id);
              }
            });
          })
          .catch((error) => alert("Error: " + error));
      }

      function sendMessage() {
        const roomId = document.getElementById("sendMessageRoomId").value;
        const senderId = document.getElementById("senderId").value;
        const content = document.getElementById("messageContent").value;
        const file = document.getElementById("fileInput").files[0]; // Get the selected file

        // Create FormData object to send data as multipart/form-data
        const formData = new FormData();
        formData.append("roomId", roomId);
        formData.append("senderId", senderId);
        formData.append("content", content);
        formData.append("file", file); // Append the file to the FormData object

        fetch(`${apiUrl}/messages`, {
          method: "POST",
          body: formData, // Send FormData object
        })
          .then((response) => response.json())
          .then((data) => console.log(data))
          .catch((error) => alert("Error: " + error));
      }

      function subscribeToRoom(roomId) {
        socket.emit("subscribeToRoom", roomId);
        document.getElementById("messages").innerHTML = ""; // Clear previous messages
        alert(`Subscribed to room ${roomId}`);
      }
      socket.on("sendMessage", async ({ message }) => {
        console.log("connected", message);
        const messagesElement = document.getElementById("messages");
        if (message.filePath) {
          const messageContainer = document.createElement("div");
          const imageElement = document.createElement("img");

          const imageUrl = `${apiUrl}/messages/file/${message.filePath}`;

          fetch(imageUrl)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              console.log(response)
              return response.blob();
            })
            .then((blob) => {
              const objectUrl = URL.createObjectURL(blob);
              imageElement.src = objectUrl;
              imageElement.onload = () => URL.revokeObjectURL(objectUrl);
            })
            .catch((error) => {
              console.error("Error fetching image:", error);
            });

          imageElement.width = 40;
          imageElement.height = 40;
          const textElement = document.createElement("div");
          textElement.textContent = `${message.senderId}: ${message.content}`;
          messageContainer.appendChild(imageElement);
          messageContainer.appendChild(textElement);
          messagesElement.appendChild(messageContainer);
        } else {
          messagesElement.innerHTML += `<div>${message.senderId}: ${message.content}</div>`;
        }
      });
      // Initialize room list on page load
      getAllRooms();
    </script>
  </body>
</html>
